#!/usr/bin/env python3
#
# <div class="cardcontainer">
#     <p class="kanji_character question">
#         <span style="font-family: mykanjifont; font-size: 120px; ">三</span>
#     </p>
#
#     <div class="questionhelp">
#         <p>
#             <span class="kanji_character">三人</span>
#             <span class="particles">で</span>
#         </p>
#         <div></div>
#
#         <div class="cardcontainer answer">
#             <span style="font-family: mykanjifont; font-size: 120px; ">三</span>
#             <div class="header">
#                 <div class="row">
#                     <div class="span8">
#                         <h1>
#                             <span class="kanji_character">三</span>
#                             <span class="translation">three</span>
#                         </h1>
#                     </div>
#                     <div class="span4 text-righted">
#                         <span class="usefulness-stars" title="5 out of 5 stars">★★★★★</span>
#                         <div>3 strokes</div>
#                         <div>
#                             <a class="label label-info" href="http://www.kanjidamage.com/tags/19" title="PROPER NOUN &ndash; this kanji is often used in names of people or places.">PN</a>
#                             <a class="label label-info" href="http://www.kanjidamage.com/tags/28" title="a kanji that (surprisingly) looks like what it represents: 山(mountain),　口(mouth), 木 (tree), or　三 (3).">DUH</a>
#                         </div>
#                     </div>
#                 </div>
#             </div>
#             <div></div>
#             <h2>Onyomi</h2>
#             <table class="definition">
#                 <tbody>
#                     <tr>
#                         <td>
#                             <span class="onyomi">SAN</span>
#                         </td>
#                         <td>
#                             <p>as in,  "
#
#                                 <span class="onyomi">SANTA</span> Claus has
#
#                                 <span class="translation">three</span> wives."
#
#                             </p>
#                         </td>
#                     </tr>
#                 </tbody>
#             </table>
#             <h2>Kunyomi</h2>
#             <table class="definition">
#                 <tbody>
#                     <tr>
#                         <td>
#                             <span class="kanji_character">み*つ</span>
#                         </td>
#                         <td> (also sometimes pronounced み＊っつ) three things. Yes, it's got 2 pronunciations
#
#                             <br/>
#                             <span class="usefulness-stars" title="4 out of 5 stars">★★★★☆</span>
#                         </td>
#                     </tr>
#                 </tbody>
#             </table>
#             <h2>Jukugo</h2>
#             <table class="definition">
#                 <tbody>
#                     <tr>
#                         <td>
#                             <ruby>
#                                 <span class="kanji_character">
#                                     <ruby>三人
#
#                                         <rp>(</rp>
#                                         <rt>さんにん</rt>
#                                         <rp>)</rp>
#                                     </ruby>
#                                 </span>
#                                 <span class="particles">で</span>
#                             </ruby>
#                         </td>
#                         <td>
#                             <p> can you guess?!???
#
#                                 <span class="usefulness-stars" title="5 out of 5 stars">★★★★★</span>
#                                 <br/>
#                                 <a class="component" href="http://www.kanjidamage.com/kanji/3-three-%E4%B8%89">三</a> (three) +
#
#                                 <a class="component" href="http://www.kanjidamage.com/kanji/61-person-%E4%BA%BA">人</a> (person)  = 三人 (can you guess?!???)
#
#                             </p>
#                         </td>
#                     </tr>
#                     <tr>
#                         <td>
#                             <ruby>
#                                 <span class="kanji_character">
#                                     <ruby>三月
#
#                                         <rp>(</rp>
#                                         <rt>さんがつ</rt>
#                                         <rp>)</rp>
#                                     </ruby>
#                                 </span>
#                             </ruby>
#                         </td>
#                         <td>
#                             <p> March
#
#                                 <span class="usefulness-stars" title="5 out of 5 stars">★★★★★</span>
#                                 <a class="label label-info" href="http://www.kanjidamage.com/tags/12" title="Yet another only-in-Japanese headache: All kanji are written as hiragana. . . TO SOME EXTENT.">KANA</a>
#                                 <br/>
#                                 <a class="component" href="http://www.kanjidamage.com/kanji/3-three-%E4%B8%89">三</a> (three) +
#
#                                 <a class="component" href="http://www.kanjidamage.com/kanji/41-moon-organ-%E6%9C%88">月</a> (moon)  = 三月 (March)
#
#                             </p>
#                         </td>
#                     </tr>
#                     <tr>
#                         <td>
#                             <ruby>
#                                 <span class="kanji_character">
#                                     <ruby>三角
#
#                                         <rp>(</rp>
#                                         <rt>さんかく</rt>
#                                         <rp>)</rp>
#                                     </ruby>
#                                 </span>
#                             </ruby>
#                         </td>
#                         <td>
#                             <p> triangle
#
#                                 <span class="usefulness-stars" title="2 out of 5 stars">★★☆☆☆</span>
#                                 <br/>
#                                 <a class="component" href="http://www.kanjidamage.com/kanji/3-three-%E4%B8%89">三</a> (three) +
#
#                                 <a class="component" href="http://www.kanjidamage.com/kanji/561-horncorner-%E8%A7%92">角</a> (horn/corner)  = 三角 (triangle)
#
#                             </p>
#                         </td>
#                     </tr>
#                 </tbody>
#             </table>
#             <h2>Used in</h2>
#             <ul class="lacidar">
#                 <li>
#                     <a href="http://www.kanjidamage.com/kanji/11-say-%E8%A8%80">言</a>
#                 </li>
#                 <li>
#                     <a href="http://www.kanjidamage.com/kanji/995-lifespansushi-%E5%AF%BF">寿</a>
#                 </li>
#                 <li>
#                     <a href="http://www.kanjidamage.com/kanji/959-three-stooges">
#                         <img alt="3-stooges" src="3-stooges-small.jpg"/>
#                     </a>
#                 </li>
#             </ul>
#         </div>

from lxml import etree
from collections import defaultdict
from pprint import pprint
import json


data_path = "../resources/kanjidamage-anki-cards-export.txt"

kanji2meaning = {}

with open(data_path, "r") as data_file:
    for line in data_file:

        fixed_line = line.strip().strip('"').replace('""', '"')
        parser = etree.XMLParser(recover=True)
        elem = etree.fromstring(fixed_line, parser=parser)

        usefulness_stars = elem.xpath(".//span[@class='usefulness-stars']")
        if not usefulness_stars:
            # this is not a real kanji but a made up radical
            continue

        kanji = elem.xpath(".//h1/span[@class='kanji_character']")
        assert len(kanji) == 1, "Only one element should match kanji"
        # if len(kanji[0]) > 0:
        #     # the kanji element contains an image href child,
        #     # this is not a real kanji but a made up radical
        #     continue
        kanji_text = kanji[0].text

        meaning = elem.xpath(".//h1/span[@class='translation']")
        assert len(meaning) == 1, "Only one element should match kanji keyword"
        meaning_text = meaning[0].text
        assert len(meaning_text) >= 2, "kanji keyword must be >=2 chars in length"
        kanji2meaning[kanji_text] = meaning_text

with open("../resources/keywords-kanjidamage-meanings.json", "w", encoding="utf-8") as f:
    json.dump(kanji2meaning, f, ensure_ascii=False, indent=2)
