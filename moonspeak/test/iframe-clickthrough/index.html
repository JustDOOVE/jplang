<!DOCTYPE html>
<html>
<head>
<style>
body, html {
    margin: 0;
    padding: 0;
    width: 100vw; 
    height: 100vh;
}

.colored {
    background-color: red;
}

.fullscreen {
    position: absolute;
    width: 100vw;
    height: 100vh;
    border: none;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    background-color: transparent;
    pointer-events: none;
}

.active {
    pointer-events: auto;
}

.hidden {
    display: none;
}

</style>
</head>

<body onload="getDataIFrame()">

<div id="featuresContainer">
    <iframe id="frame_background" class="fullscreen" src="./frame_background.html"></iframe>
    <iframe id="frame_plus" class="fullscreen" src="./frame_plus.html"></iframe>
    <iframe id="frame_question" class="fullscreen" src="./frame_question.html"></iframe>
    <iframe id="frame_alert" class="fullscreen" src="./frame_alert.html"></iframe>
    <iframe id="frame_input" class="fullscreen" src="./frame_input.html"></iframe>
</div>
<div id="eventTrap" class="active fullscreen"></div>

<script>

let fullscreenFrames = new Array();
let container = document.getElementById("featuresContainer");
for (const child of container.childNodes) {
    if (child.tagName !== "IFRAME") {
        continue;
    }
    fullscreenFrames.push(child);
}
fullscreenFrames.reverse();

let STATE_PROPOGATING = "propogating";
let STATE_HANDLED = "handled";


async function getDataIFrame() {
    let ids = [
        "frame_background",
        "frame_question",
        "frame_plus",
        "frame_alert",
        "frame_input",
    ];

    let eventTrap = document.getElementById("eventTrap");

    let handler = (e) => {
        let evt = new MouseEvent(e.type, e);
        evt.moonspeakEventState = STATE_PROPOGATING;
        for (const child of fullscreenFrames) {
                if (evt.moonspeakEventState === STATE_HANDLED) {
                    // stop early if event was handled
                    break; 
                }
                let innerEl = child.contentWindow.document.elementFromPoint(e.clientX, e.clientY);
                if (innerEl) {
                    innerEl.dispatchEvent(evt);
                }
        };
    }

    eventTrap.addEventListener('click', handler, true);

    for (const name of ids) {
        let iframeElem = document.getElementById(name);
        let iframeHtml = iframeElem.contentWindow.document.documentElement;
        iframeHtml.addEventListener('click', (e) => {
            if (e.target !== iframeHtml && (! e.target.classList.contains('deadzone'))) {
                // if target element: is not document.html tag and not deadzone css class
                // means user clicked on something worthwhile (likely with a lower click event handler)
                e.moonspeakEventState = STATE_HANDLED;
                eventTrap.classList.remove('active');
                iframeElem.classList.add('active');
            } else if (iframeElem.classList.contains('active')) {
                // user clicked on non-active element, so current iframe should stop being active
                iframeElem.classList.remove('active');
                eventTrap.classList.add('active');
                let evt = new MouseEvent('click', e);
                eventTrap.dispatchEvent(evt);
            }
        });
    };
}

</script>

</body>
</html>
